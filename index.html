<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tablero KPI - Transporte San José S.A</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #0b1220;
      --muted: #8fa3c0;
      --text: #eaf1ff;
      --border: rgba(255,255,255,.08);
      --good: #29d391;
      --warn: #ffd166;
      --bad:  #ff5c7a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% 0%, #132043 0%, var(--bg) 55%);
      color: var(--text);
    }
    header {
      padding: 18px 22px;
      display: flex; align-items: baseline; justify-content: space-between; gap: 12px;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(8px);
      position: sticky; top: 0;
      background: rgba(11,18,32,.55);
    }
    h1 { margin: 0; font-size: 18px; letter-spacing: .2px; }
    .meta { color: var(--muted); font-size: 12px; display:flex; gap: 16px; flex-wrap: wrap; }
    .controls { display:flex; gap: 10px; align-items: center; }
    .controls label { font-size: 12px; color: var(--muted); }
    input[type="number"]{
      width: 110px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      outline: none;
    }
    button{
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 650;
    }
    button:hover{ background: rgba(255,255,255,.09); }

    .wrap { padding: 18px 22px 28px; max-width: 1200px; margin: 0 auto; }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
    }
    .card h2 { margin: 0 0 10px; font-size: 14px; color: #cfe0ff; font-weight: 650; }

    .kpi-grid {
      display: grid; gap: 10px;
      grid-template-columns: repeat(4, minmax(0,1fr));
    }
    @media (max-width: 960px){ .kpi-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .kpi {
      padding: 12px;
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
    }
    .kpi .name { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    .kpi .val { font-size: 22px; font-weight: 750; letter-spacing: .2px; }
    .kpi .sub { margin-top: 6px; font-size: 12px; color: var(--muted); display:flex; justify-content: space-between; }

    .pill { padding: 2px 8px; border-radius: 999px; font-weight: 650; border: 1px solid var(--border); }
    .pill.good{ color: var(--good); }
    .pill.warn{ color: var(--warn); }
    .pill.bad{  color: var(--bad);  }

    .row {
      display: grid; gap: 14px;
      grid-template-columns: 1fr 1fr;
      margin-top: 14px;
    }
    @media (max-width: 960px){ .row{ grid-template-columns: 1fr; } }

    canvas { width: 100% !important; height: 280px !important; }

    table {
      width: 100%; border-collapse: collapse; font-size: 12px;
      overflow: hidden; border-radius: 12px; border: 1px solid var(--border);
    }
    th, td { padding: 10px 10px; border-bottom: 1px solid var(--border); }
    th { text-align: left; color: #cfe0ff; background: rgba(255,255,255,.03); }
    td { color: #eaf1ff; }
    tr:last-child td { border-bottom: none; }
    .right { text-align: right; }
    .muted { color: var(--muted); }

    .alert {
      margin-top: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    code { color: #cfe0ff; }
  </style>
</head>

<body>
<header>
  <h1>Tablero KPI - Transporte San José S.A</h1>
  <div class="meta">
    <div>Estado: <span id="status" class="muted">iniciando…</span></div>
    <div>Última actualización: <span id="lastUpdate" class="muted">—</span></div>
    <div class="controls">
      <label>Refresh (s)</label>
      <input id="refreshSec" type="number" min="5" step="5" value="30" />
      <button id="btnNow">Actualizar</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h2>KPI's (Día vs Acumulado)</h2>
    <div id="kpiGrid" class="kpi-grid"></div>
    <div id="help" class="alert" style="display:none;"></div>
  </div>

  <div class="row">
    <div class="card">
      <h2>Comparativo Día vs Acumulado</h2>
      <canvas id="barChart"></canvas>
    </div>

    <div class="card">
      <h2>Detalle</h2>
      <table>
        <thead>
          <tr>
            <th>Indicador</th>
            <th id="thDay" class="right">Día</th>
            <th id="thAcum" class="right">Acum</th>
          </tr>
        </thead>
        <tbody id="detailBody"></tbody>
      </table>
      <div class="muted" style="margin-top:10px;font-size:12px;">
        Se reconsulta en cada refresh.
      </div>
    </div>
  </div>
</div>

<script>
  // ============================================================================
  // CONFIG (TU PUBLICACIÓN)
  // ============================================================================
  const PUBLISHED_KEY = "2PACX-1vQ6GRrP2Qr38OV2puOeVMdHQz6-7Oy1zhHWGyx1p5woGJRa0FBws02pPIMUDhTEVMuKKrn3j32TF2xX";

  // Si tu pestaña publicada NO es la primera, este gid puede ser distinto.
  // Probá 0, luego 1, 2, etc.
  const GID = 0;

  // Endpoint CSV de sheets publicados (estable)
  const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_KEY}/pub?output=csv&gid=${GID}`;

  // ============================================================================

  let barChart;

  function setStatus(txt){ document.getElementById("status").textContent = txt; }
  function setLastUpdate(d){
    document.getElementById("lastUpdate").textContent = d ? d.toLocaleString("es-AR") : "—";
  }
  function showHelp(html){
    const el = document.getElementById("help");
    el.style.display = "block";
    el.innerHTML = html;
  }
  function hideHelp(){
    const el = document.getElementById("help");
    el.style.display = "none";
    el.innerHTML = "";
  }

  // CSV parser (soporta comillas, comas, saltos)
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++){
      const c = text[i];
      const next = text[i+1];

      if (c === '"' ){
        if (inQuotes && next === '"'){ // escape ""
          cur += '"'; i++;
        } else {
          inQuotes = !inQuotes;
        }
        continue;
      }

      if (!inQuotes && (c === ',')){
        row.push(cur); cur = "";
        continue;
      }

      if (!inQuotes && (c === '\n' || c === '\r')){
        if (c === '\r' && next === '\n') i++; // CRLF
        row.push(cur);
        rows.push(row);
        row = [];
        cur = "";
        continue;
      }

      cur += c;
    }

    // último campo
    if (cur.length || row.length){
      row.push(cur);
      rows.push(row);
    }

    // limpiar filas vacías
    return rows.filter(r => r.some(x => String(x).trim() !== ""));
  }

  function norm(s){ return String(s ?? "").trim(); }
  function lower(s){ return norm(s).toLowerCase(); }

  function toNumber(v){
    if (v === null || v === undefined) return null;
    let s = String(v).trim();
    if (!s) return null;

    // % -> se conserva como 0-100
    s = s.replace("%","").trim();

    // 1.234,56 -> 1234.56
    s = s.replace(/\./g, "");
    s = s.replace(",", ".");

    const n = Number(s);
    return Number.isNaN(n) ? null : n;
  }

  function isPercentLike(v){
    return String(v ?? "").includes("%");
  }

  function deltaBadge(day, acum){
    if (day === null || acum === null) return { text: "s/d", cls: "pill warn" };
    const d = day - acum;
    const abs = Math.abs(d);
    if (abs < 0.01) return { text: "OK", cls: "pill good" };
    if (abs <= 2)   return { text: (d>0?"+":"") + d.toFixed(2), cls: "pill warn" };
    return { text: (d>0?"+":"") + d.toFixed(2), cls: "pill bad" };
  }

  async function fetchItems(){
    setStatus("consultando…");
    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("No se pudo leer el CSV publicado (revisar publicación/permisos/gid).");

    const csv = await res.text();
    const table = parseCSV(csv);
    if (table.length < 2) throw new Error("El CSV no trae datos (hoja vacía o rango publicado sin contenido).");

    const headers = table[0].map(norm);
    const dataRows = table.slice(1);

    // Detección flexible:
    // - Indicador: columna que contenga "indic" o si no, la 1ra
    // - Acumulado: columna que contenga "acum" (acum, acumulado, acum. ene, etc) o si no, la 3ra
    // - Día: la columna restante (idealmente la 2da)
    const idxIndic = headers.findIndex(h => lower(h).includes("indic"));
    const idxAcum  = headers.findIndex(h => lower(h).includes("acum"));

    let iIndic = idxIndic !== -1 ? idxIndic : 0;
    let iAcum = idxAcum !== -1 ? idxAcum : (headers.length >= 3 ? 2 : 1);
    let iDia;

    // Elegir iDia como "la columna que no sea indic ni acum", priorizando la 2da
    const candidates = [...headers.keys()].filter(i => i !== iIndic && i !== iAcum);
    iDia = candidates.includes(1) ? 1 : (candidates[0] ?? 1);

    const dayLabel = headers[iDia] || "Día";
    const acumLabel = headers[iAcum] || "Acum";

    document.getElementById("thDay").textContent = dayLabel;
    document.getElementById("thAcum").textContent = acumLabel;

    const items = dataRows
      .map(r => {
        const indicador = norm(r[iIndic]);
        const diaRaw = norm(r[iDia]);
        const acumRaw = norm(r[iAcum]);
        return {
          indicador,
          diaRaw,
          acumRaw,
          dia: toNumber(diaRaw),
          acum: toNumber(acumRaw),
          pct: isPercentLike(diaRaw) || isPercentLike(acumRaw)
        };
      })
      .filter(x => x.indicador);

    if (!items.length) throw new Error("No se pudieron construir items: revisá que la primera columna sea el nombre del indicador.");

    return items;
  }

  function renderKPIs(items){
    const kpiGrid = document.getElementById("kpiGrid");
    kpiGrid.innerHTML = "";

    items.slice(0, 8).forEach(it => {
      const badge = deltaBadge(it.dia, it.acum);
      const valText = it.diaRaw === "" ? "—" : (it.pct ? `${it.dia ?? "—"}%` : it.diaRaw);
      const acumText = it.acumRaw === "" ? "—" : (it.pct ? `${it.acum ?? "—"}%` : it.acumRaw);

      const div = document.createElement("div");
      div.className = "kpi";
      div.innerHTML = `
        <div class="name">${it.indicador}</div>
        <div class="val">${valText}</div>
        <div class="sub">
          <span class="muted">Acum: ${acumText}</span>
          <span class="${badge.cls}">${badge.text}</span>
        </div>
      `;
      kpiGrid.appendChild(div);
    });
  }

  function renderTable(items){
    const body = document.getElementById("detailBody");
    body.innerHTML = "";
    items.forEach(it => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.indicador}</td>
        <td class="right">${it.diaRaw === "" ? "—" : it.diaRaw}</td>
        <td class="right">${it.acumRaw === "" ? "—" : it.acumRaw}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderChart(items){
    const slice = items.slice(0, 12);
    const labels = slice.map(x => x.indicador);
    const daySeries = slice.map(x => x.dia);
    const acumSeries = slice.map(x => x.acum);

    const ctx = document.getElementById("barChart");
    if (barChart) barChart.destroy();

    barChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: document.getElementById("thDay").textContent, data: daySeries },
          { label: document.getElementById("thAcum").textContent, data: acumSeries }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: "#eaf1ff" } }
        },
        scales: {
          x: { ticks: { color: "#8fa3c0" }, grid: { color: "rgba(255,255,255,.06)" } },
          y: { ticks: { color: "#8fa3c0" }, grid: { color: "rgba(255,255,255,.06)" } }
        }
      }
    });
  }

  async function refresh(){
    try{
      hideHelp();
      const items = await fetchItems();
      renderKPIs(items);
      renderTable(items);
      renderChart(items);
      setStatus("ok");
      setLastUpdate(new Date());
    }catch(err){
      console.error(err);
      setStatus("error: " + err.message);

      // Ayuda práctica para los dos problemas más típicos
      const isFile = location.protocol === "file:";
      showHelp(`
        <div><strong>Checklist rápido</strong></div>
        <ol style="margin:8px 0 0 18px;padding:0;">
          <li>Si abriste el archivo como <code>file:///</code>, servilo por HTTP (recomendado). Ejemplos:</li>
        </ol>
        <div style="margin-left:18px;">
          <div>• VSCode → extensión “Live Server”</div>
          <div>• o en una carpeta: <code>python -m http.server 8000</code> y abrís <code>http://localhost:8000</code></div>
        </div>
        <div style="margin-top:10px;">
          <div>2) Si sigue sin traer datos, probá cambiar <code>GID</code> (0, 1, 2…). Tu publicación muestra “Hoja 1”, pero el gid puede variar.</div>
        </div>
        ${isFile ? `<div style="margin-top:10px;">Detecté que estás en <code>file:///</code>. Eso suele bloquear <code>fetch()</code>.</div>` : ``}
      `);
    }
  }

  // Auto refresh
  let timer;
  function startTimer(){
    if (timer) clearInterval(timer);
    const sec = Math.max(5, Number(document.getElementById("refreshSec").value) || 30);
    timer = setInterval(refresh, sec * 1000);
  }

  document.getElementById("btnNow").addEventListener("click", () => refresh());
  document.getElementById("refreshSec").addEventListener("change", () => startTimer());

  refresh();
  startTimer();
</script>
</body>
</html>

