<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tablero KPI - Google Sheets</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      /* Dark theme (negros) */
      --bg0:#07090d;
      --bg1:#0b0f16;
      --bg2:#0f1520;

      --card: rgba(255,255,255,.03);
      --card2: rgba(255,255,255,.02);
      --border: rgba(255,255,255,.10);

      --text:#eaf1ff;
      --muted: rgba(234,241,255,.70);

      --good:#2cff9a;
      --warn:#ffd166;
      --bad:#ff6b81;

      --focus: rgba(234,241,255,.65);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      min-height: 100vh;

      background:
        radial-gradient(900px 600px at 20% 0%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(700px 500px at 80% 10%, rgba(255,255,255,.04) 0%, rgba(255,255,255,0) 55%),
        linear-gradient(180deg, var(--bg2) 0%, var(--bg1) 45%, var(--bg0) 100%);
    }

    header{
      padding:18px 22px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;

      position:sticky;
      top:0;
      z-index:10;

      background: rgba(8,10,14,.65);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.12);
    }

    h1{ margin:0; font-size:18px; letter-spacing:.2px; }

    .meta{
      font-size:12px;
      color: var(--muted);
      display:flex;
      gap:16px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .controls{ display:flex; gap:8px; align-items:center; }
    .controls label{ color: var(--muted); }

    input[type="number"]{
      width:110px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      outline:none;
    }

    button{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      font-weight:650;
    }
    button:hover{ background: rgba(255,255,255,.06); }

    button:focus-visible,
    input:focus-visible{
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }

    .wrap{ max-width:1200px; margin:0 auto; padding:18px 22px 28px; }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }
    @media(max-width:900px){
      .row{ grid-template-columns:1fr; }
    }

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 28px rgba(0,0,0,.40);
    }
    .card h2{
      margin:0 0 12px;
      font-size:14px;
      color: rgba(234,241,255,.92);
      font-weight: 700;
      display:flex;
      align-items:baseline;
      justify-content: space-between;
      gap: 10px;
    }
    .subtitle{
      font-size:12px;
      color: var(--muted);
      font-weight: 650;
      white-space: nowrap;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
      align-items: stretch;
    }
    @media(max-width:900px){
      .kpi-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    .kpi{
      min-height: 140px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);

      display:flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .kpi .name{
      font-size: 12px;
      color: var(--muted);
      min-height: 32px;
      line-height: 1.2;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .kpi .val{
      font-size: 22px;
      font-weight: 750;
      letter-spacing: .2px;
      font-variant-numeric: tabular-nums;
    }

    .kpi .sub{
      margin-top: 10px;
      display:flex;
      justify-content:flex-end;
      align-items:center;
    }

    .pill{
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 750;
      border: 1px solid rgba(255,255,255,.16);
      font-variant-numeric: tabular-nums;
    }
    .pill.good{
      color: var(--good);
      background: rgba(44,255,154,.14);
      border-color: rgba(44,255,154,.28);
    }
    .pill.warn{
      color: var(--warn);
      background: rgba(255,209,102,.14);
      border-color: rgba(255,209,102,.28);
    }
    .pill.bad{
      color: var(--bad);
      background: rgba(255,107,129,.14);
      border-color: rgba(255,107,129,.28);
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 12px;
      border-radius: 12px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
    }
    th,td{
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      font-variant-numeric: tabular-nums;
    }
    th{
      text-align:left;
      color: rgba(234,241,255,.92);
      background: rgba(255,255,255,.03);
    }
    tbody tr:nth-child(odd) td{ background: rgba(255,255,255,.015); }
    tbody tr:hover td{ background: rgba(255,255,255,.04); }
    .right{ text-align:right; }

    .full-row{ margin-top: 14px; }

    canvas{ width:100% !important; height: 420px !important; }

    .muted{ color: var(--muted); }

    .alert{
      margin-top:10px;
      padding:10px 12px;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      word-break: break-word;
    }

    code{ color: rgba(234,241,255,.92); }

    /* =========================
       PDF/PRINT STYLES (DÍA)
       ========================= */
    .print-only{ display:none; }

    @page { size: A4; margin: 12mm; }

    @media print{
      body{ background:#fff !important; color:#000 !important; }
      header, .wrap{ display:none !important; }
      #pdfDay{
        display:block !important;
        position:static !important;
      }
      *{ box-shadow:none !important; text-shadow:none !important; }
    }

    #pdfDay{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:#000;
    }

    .print-header{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      border-bottom: 1px solid rgba(0,0,0,.12);
      padding-bottom:10px;
      margin-bottom:12px;
    }
    .print-title{
      font-size:16px;
      font-weight:800;
    }
    .print-subtitle{
      font-size:12px;
      color: rgba(0,0,0,.70);
      margin-top:2px;
    }
    .print-meta{
      font-size:11px;
      color: rgba(0,0,0,.70);
      text-align:right;
      line-height:1.35;
    }

    .print-kpi-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:8px;
      margin:10px 0 12px;
    }
    .print-kpi{
      border:1px solid rgba(0,0,0,.14);
      border-radius:10px;
      padding:10px;
      min-height:92px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .print-kpi .name{
      font-size:11px;
      color: rgba(0,0,0,.65);
      line-height:1.2;
    }
    .print-kpi .val{
      font-size:18px;
      font-weight:850;
      font-variant-numeric: tabular-nums;
    }

    .print-pill{
      align-self:flex-end;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      border:1px solid rgba(0,0,0,.14);
    }
    .print-pill.good{ color:#0a7a3f; background: rgba(10,122,63,.10); border-color: rgba(10,122,63,.25); }
    .print-pill.warn{ color:#8a6a00; background: rgba(138,106,0,.10); border-color: rgba(138,106,0,.25); }
    .print-pill.bad{  color:#9a1b2e; background: rgba(154,27,46,.10); border-color: rgba(154,27,46,.25); }

    .print-section-title{
      font-size:12px;
      font-weight:800;
      margin:6px 0 6px;
    }

    .print-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      border:1px solid rgba(0,0,0,.14);
    }
    .print-table th, .print-table td{
      padding:8px;
      border-bottom: 1px solid rgba(0,0,0,.10);
      font-variant-numeric: tabular-nums;
    }
    .print-table th{
      text-align:left;
      background: rgba(0,0,0,.04);
    }

    .print-footnote{
      margin-top:8px;
      font-size:10px;
      color: rgba(0,0,0,.60);
    }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Tablero KPI – Transporte San José S.A (Tráfico PRA)</h1>
  </div>

  <div class="meta">
    <div>Estado: <span id="status" class="muted">iniciando…</span></div>
    <div>Última actualización: <span id="lastUpdate" class="muted">—</span></div>
    <div class="controls">
      <label for="refreshSec">Refresh (s)</label>
      <input id="refreshSec" type="number" min="5" step="5" value="30" />
      <button id="btnNow" type="button">Actualizar</button>
      <button id="btnPdfDay" type="button">PDF (Día)</button>
    </div>
  </div>
</header>

<div class="wrap">

  <div class="row">
    <!-- Día -->
    <section class="card">
      <h2>
        <span>KPIs (Día)</span>
        <span id="subtitleDay" class="subtitle"></span>
      </h2>
      <div id="kpiGridDay" class="kpi-grid"></div>

      <h2 style="margin-top:16px;">
        <span>Detalle (Día)</span>
        <span id="subtitleDay2" class="subtitle"></span>
      </h2>
      <table>
        <thead>
          <tr>
            <th>Indicador</th>
            <th class="right" id="thDayLabel">Día</th>
          </tr>
        </thead>
        <tbody id="detailBodyDay"></tbody>
      </table>

      <div id="helpDay" class="alert" style="display:none;"></div>
    </section>

    <!-- Mes -->
    <section class="card">
      <h2>
        <span>KPIs (Acumulado)</span>
        <span id="subtitleMes" class="subtitle"></span>
      </h2>
      <div id="kpiGridMes" class="kpi-grid"></div>

      <h2 style="margin-top:16px;">
        <span>Detalle (Acumulado)</span>
        <span id="subtitleMes2" class="subtitle"></span>
      </h2>
      <table>
        <thead>
          <tr>
            <th>Indicador</th>
            <th class="right" id="thMesLabel">Mes</th>
          </tr>
        </thead>
        <tbody id="detailBodyMes"></tbody>
      </table>

      <div id="helpMes" class="alert" style="display:none;"></div>
    </section>
  </div>

  <!-- Comparativo -->
  <section class="card full-row">
    <h2>Comparativo (Día vs Acumulado)</h2>
    <canvas id="chartCompare"></canvas>
    <div id="chartMsg" class="alert" style="display:none;margin-top:10px;"></div>
    <div class="muted" style="margin-top:10px;font-size:12px;">
      Fuente: Google Sheets (publicado). Se reconsulta en cada refresh.
    </div>
  </section>

</div>

<!-- =========================
     REPORTE IMPRIMIBLE (DÍA)
     ========================= -->
<section id="pdfDay" class="print-only">
  <div class="print-header">
    <div>
      <div class="print-title">Reporte KPI – Día</div>
      <div class="print-subtitle" id="pdfDaySubtitle">—</div>
    </div>
    <div class="print-meta">
      <div><strong>Generado:</strong> <span id="pdfGeneratedAt">—</span></div>
      <div><strong>Fuente:</strong> Google Sheets (publicado)</div>
    </div>
  </div>

  <div class="print-kpi-grid" id="pdfKpiGridDay"></div>

  <div class="print-section-title">Detalle (Día)</div>
  <table class="print-table">
    <thead>
      <tr>
        <th>Indicador</th>
        <th class="right" id="pdfThDayLabel">Día</th>
      </tr>
    </thead>
    <tbody id="pdfDetailBodyDay"></tbody>
  </table>

  <div class="print-footnote">
    Nota: el semáforo es referencial para valores porcentuales (OK ≥ 80%, Atención 40–79%, Crítico &lt; 40%).
  </div>
</section>

<script>
  // ============================================================================
  // CONFIG (TU PUBLICACIÓN)
  // ============================================================================
  const PUBLISHED_KEY = "2PACX-1vQ6GRrP2Qr38OV2puOeVMdHQz6-7Oy1zhHWGyx1p5woGJRa0FBws02pPIMUDhTEVMuKKrn3j32TF2xX";
  const GID = 0;
  const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_KEY}/pub?output=csv&gid=${GID}`;
  // ============================================================================

  let chartCompare;

  function setStatus(txt){ document.getElementById("status").textContent = txt; }
  function setLastUpdate(d){
    document.getElementById("lastUpdate").textContent = d ? d.toLocaleString("es-AR") : "—";
  }

  function showHelp(which, html){
    const el = document.getElementById(which === "day" ? "helpDay" : "helpMes");
    el.style.display = "block";
    el.innerHTML = html;
  }
  function hideHelp(which){
    const el = document.getElementById(which === "day" ? "helpDay" : "helpMes");
    el.style.display = "none";
    el.innerHTML = "";
  }

  function showChartMsg(html){
    const el = document.getElementById("chartMsg");
    el.style.display = "block";
    el.innerHTML = html;
  }
  function hideChartMsg(){
    const el = document.getElementById("chartMsg");
    el.style.display = "none";
    el.innerHTML = "";
  }

  // === Fecha actual para títulos/labels (automatiza Día/Mes según calendario) ===
  function setAutoPeriodLabels(){
    const now = new Date();

    const dayShort = now.toLocaleDateString("es-AR", { weekday:"short" });
    const dayDate  = now.toLocaleDateString("es-AR");
    const monthLong = now.toLocaleDateString("es-AR", { month:"long", year:"numeric" });

    document.getElementById("subtitleDay").textContent  = `${dayShort} ${dayDate}`;
    document.getElementById("subtitleDay2").textContent = `${dayShort} ${dayDate}`;

    document.getElementById("subtitleMes").textContent  = monthLong;
    document.getElementById("subtitleMes2").textContent = monthLong;

    document.getElementById("thDayLabel").textContent = `Día (${dayDate})`;
    document.getElementById("thMesLabel").textContent = `Mes (${monthLong})`;
  }

  // CSV parser (soporta comillas, comas, saltos)
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++){
      const c = text[i];
      const next = text[i+1];

      if (c === '"'){
        if (inQuotes && next === '"'){ cur += '"'; i++; }
        else { inQuotes = !inQuotes; }
        continue;
      }

      if (!inQuotes && c === ','){
        row.push(cur); cur = "";
        continue;
      }

      if (!inQuotes && (c === '\n' || c === '\r')){
        if (c === '\r' && next === '\n') i++;
        row.push(cur);
        rows.push(row);
        row = [];
        cur = "";
        continue;
      }

      cur += c;
    }

    if (cur.length || row.length){
      row.push(cur);
      rows.push(row);
    }

    return rows.filter(r => r.some(x => String(x).trim() !== ""));
  }

  function norm(s){ return String(s ?? "").trim(); }
  function lower(s){ return norm(s).toLowerCase(); }

  function toNumber(v){
    if (v === null || v === undefined) return null;
    let s = String(v).trim();
    if (!s) return null;

    s = s.replace("%","").trim();
    s = s.replace(/\./g, "");
    s = s.replace(",", ".");

    const n = Number(s);
    return Number.isNaN(n) ? null : n;
  }

  function isPercentLike(v){
    return String(v ?? "").includes("%");
  }

  function badgeForValue(val, isPercent){
    if (val === null) return { text: "s/d", cls: "pill warn" };

    if (isPercent){
      if (val >= 80) return { text: "OK", cls: "pill good" };
      if (val >= 40) return { text: "Atención", cls: "pill warn" };
      return { text: "Crítico", cls: "pill bad" };
    }

    return { text: "ver", cls: "pill warn" };
  }

  async function fetchData(){
    setStatus("consultando…");

    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("No se pudo leer el CSV publicado (revisar publicación/permisos/gid).");

    const csv = await res.text();
    const table = parseCSV(csv);
    if (table.length < 2) throw new Error("El CSV no trae datos (hoja vacía o rango publicado sin contenido).");

    const headers = table[0].map(norm);
    const dataRows = table.slice(1);

    const hLower = headers.map(h => lower(h));
    const idxIndic = hLower.findIndex(h => h.includes("indic"));
    const idxDia   = hLower.findIndex(h => h.includes("día") || h.includes("dia") || h.includes("diario"));
    const idxMes   = hLower.findIndex(h => h.includes("mes") || h.includes("mensual") || h.includes("acum") || h.includes("acumul"));

    let iIndic = idxIndic !== -1 ? idxIndic : 0;
    let iDia   = idxDia   !== -1 ? idxDia   : 1;
    let iMes   = idxMes   !== -1 ? idxMes   : (headers.length >= 3 ? 2 : 1);

    if (iDia === iIndic) iDia = (iIndic === 0 ? 1 : 0);
    if (iMes === iIndic || iMes === iDia){
      const candidates = [...headers.keys()].filter(i => i !== iIndic && i !== iDia);
      iMes = candidates[0] ?? iMes;
    }

    const dayLabel = headers[iDia] || "Día";
    const mesLabel = headers[iMes] || "Mes";

    const items = dataRows
      .map(r => {
        const indicador = norm(r[iIndic]);
        const diaRaw = norm(r[iDia]);
        const mesRaw = norm(r[iMes]);
        return {
          indicador,
          diaRaw,
          mesRaw,
          dia: toNumber(diaRaw),
          mes: toNumber(mesRaw),
          pctDia: isPercentLike(diaRaw),
          pctMes: isPercentLike(mesRaw)
        };
      })
      .filter(x => x.indicador);

    if (!items.length) throw new Error("No se pudieron construir items: revisá la columna del indicador.");

    return { items, dayLabel, mesLabel };
  }

  function renderKPIs(items, mode){
    const grid = document.getElementById(mode === "day" ? "kpiGridDay" : "kpiGridMes");
    grid.innerHTML = "";

    items.slice(0, 8).forEach(it => {
      const raw = mode === "day" ? it.diaRaw : it.mesRaw;
      const val = mode === "day" ? it.dia : it.mes;
      const pct = mode === "day" ? it.pctDia : it.pctMes;

      const badge = badgeForValue(val, pct);
      const valText = raw === "" ? "—" : raw;

      const div = document.createElement("div");
      div.className = "kpi";
      div.innerHTML = `
        <div class="name">${it.indicador}</div>
        <div class="val">${valText}</div>
        <div class="sub">
          <span class="${badge.cls}">${badge.text}</span>
        </div>
      `;
      grid.appendChild(div);
    });
  }

  function renderTable(items, mode){
    const body = document.getElementById(mode === "day" ? "detailBodyDay" : "detailBodyMes");
    body.innerHTML = "";

    items.forEach(it => {
      const raw = mode === "day" ? it.diaRaw : it.mesRaw;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.indicador}</td>
        <td class="right">${raw === "" ? "—" : raw}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderCompareChart(items, dayLabel, mesLabel){
    const slice = items.slice(0, 12);

    const labels = [];
    const daySeries = [];
    const mesSeries = [];

    for (const x of slice){
      const d = Number.isFinite(x.dia) ? x.dia : null;
      const m = Number.isFinite(x.mes) ? x.mes : null;

      if (d === null && m === null) continue;

      labels.push(x.indicador);
      daySeries.push(d);
      mesSeries.push(m);
    }

    if (!labels.length){
      if (chartCompare) { chartCompare.destroy(); chartCompare = null; }
      showChartMsg("No hay valores numéricos suficientes para graficar (revisá que Día/Mes sean números o porcentajes).");
      return;
    }

    hideChartMsg();

    const ctx = document.getElementById("chartCompare").getContext("2d");
    if (chartCompare) chartCompare.destroy();

    chartCompare = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: dayLabel, data: daySeries },
          { label: mesLabel, data: mesSeries }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        layout: { padding: { top: 6, right: 10, bottom: 18, left: 10 } },
        plugins: {
          legend: { labels: { color: "rgba(234,241,255,.92)" } },
          tooltip: {
            callbacks: {
              label: (c) => `${c.dataset.label}: ${c.raw === null ? "—" : c.raw}`
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: "rgba(234,241,255,.72)",
              align: "center",
              autoSkip: false,
              maxRotation: 20,
              minRotation: 0,
              padding: 8,
              callback: function(value) {
                const label = String(this.getLabelForValue(value) ?? "");

                // cortes preferidos
                const preferred = [" vs ", " de ", " para "];
                for (const sep of preferred) {
                  if (label.includes(sep) && label.length > 18) {
                    const parts = label.split(sep);
                    if (parts.length >= 2) {
                      return [
                        parts[0].trim(),
                        (sep.trim() + " " + parts.slice(1).join(sep).trim())
                      ];
                    }
                  }
                }

                // fallback: wrap por longitud (máx 2 líneas)
                const max = 18;
                if (label.length <= max) return label;

                const words = label.split(" ");
                const lines = [];
                let cur = "";

                for (const w of words) {
                  const next = (cur ? cur + " " : "") + w;
                  if (next.length <= max) cur = next;
                  else {
                    if (cur) lines.push(cur);
                    cur = w;
                  }
                  if (lines.length === 2) break;
                }
                if (cur && lines.length < 2) lines.push(cur);

                return lines;
              }
            },
            grid: { color: "rgba(255,255,255,.10)" }
          },
          y: {
            ticks: { color: "rgba(234,241,255,.72)" },
            grid: { color: "rgba(255,255,255,.10)" }
          }
        }
      }
    });
  }

  // ======= REPORTE IMPRIMIBLE (DÍA) =======
  function renderPdfDay(items){
    const now = new Date();
    const dayShort = now.toLocaleDateString("es-AR", { weekday:"short" });
    const dayDate  = now.toLocaleDateString("es-AR");

    document.getElementById("pdfDaySubtitle").textContent = `Transporte San José S.A – ${dayShort} ${dayDate}`;
    document.getElementById("pdfGeneratedAt").textContent = now.toLocaleString("es-AR");
    document.getElementById("pdfThDayLabel").textContent = `Día (${dayDate})`;

    // KPIs: mismos 8 del tablero
    const grid = document.getElementById("pdfKpiGridDay");
    grid.innerHTML = "";
    items.slice(0, 8).forEach(it => {
      const raw = it.diaRaw;
      const val = it.dia;
      const pct = it.pctDia;

      const badge = badgeForValue(val, pct);
      const valText = raw === "" ? "—" : raw;

      const cls = badge.cls.includes("good") ? "good" : badge.cls.includes("bad") ? "bad" : "warn";

      const div = document.createElement("div");
      div.className = "print-kpi";
      div.innerHTML = `
        <div class="name">${it.indicador}</div>
        <div class="val">${valText}</div>
        <div class="print-pill ${cls}">${badge.text}</div>
      `;
      grid.appendChild(div);
    });

    // Detalle
    const body = document.getElementById("pdfDetailBodyDay");
    body.innerHTML = "";
    items.forEach(it => {
      const raw = it.diaRaw;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.indicador}</td>
        <td class="right">${raw === "" ? "—" : raw}</td>
      `;
      body.appendChild(tr);
    });
  }

  async function refresh(){
    try{
      setAutoPeriodLabels();

      hideHelp("day");
      hideHelp("mes");
      hideChartMsg();

      const { items, dayLabel, mesLabel } = await fetchData();

      renderKPIs(items, "day");
      renderTable(items, "day");

      renderKPIs(items, "mes");
      renderTable(items, "mes");

      renderCompareChart(items, dayLabel, mesLabel);

      // Mantener listo el reporte PDF del Día
      renderPdfDay(items);

      setStatus("ok");
      setLastUpdate(new Date());
    } catch (err){
      console.error(err);
      setStatus("error: " + err.message);

      const helpHtml = `
        <div><strong>Checklist rápido</strong></div>
        <ol style="margin:8px 0 0 18px;padding:0;">
          <li>Verificación directa: abrí esta URL en el navegador:</li>
        </ol>
        <div style="margin-left:18px;margin-top:6px;"><code>${CSV_URL}</code></div>
        <div style="margin-top:10px;">
          Si ves HTML en lugar de CSV (texto con comas), revisá publicación/permisos o el <code>GID</code>.
        </div>
        <div style="margin-top:10px;">
          Sugerencia: en GitHub Pages esto funciona por HTTPS; si estás probando local, evitá <code>file:///</code>.
        </div>
      `;
      showHelp("day", helpHtml);
      showHelp("mes", helpHtml);
      showChartMsg("No se pudo cargar el gráfico porque falló la lectura del CSV. Revisá publicación/permisos/gid.");
    }
  }

  // Auto refresh
  let timer;
  function startTimer(){
    if (timer) clearInterval(timer);
    const sec = Math.max(5, Number(document.getElementById("refreshSec").value) || 30);
    timer = setInterval(refresh, sec * 1000);
  }

  document.getElementById("btnNow").addEventListener("click", () => refresh());
  document.getElementById("refreshSec").addEventListener("change", () => startTimer());

  // Botón PDF (Día): asegura datos frescos y abre diálogo "Guardar como PDF"
  document.getElementById("btnPdfDay").addEventListener("click", async () => {
    try{
      const { items } = await fetchData();
      renderPdfDay(items);
      window.print();
    } catch (err){
      alert("No se pudo generar el PDF: " + err.message);
    }
  });

  setAutoPeriodLabels();
  refresh();
  startTimer();
</script>
</body>
</html>
    const now = new Date();

    const dayShort = now.toLocaleDateString("es-AR", { weekday:"short" });
    const dayDate  = now.toLocaleDateString("es-AR");
    const monthLong = now.toLocaleDateString("es-AR", { month:"long", year:"numeric" });

    document.getElementById("subtitleDay").textContent  = `${dayShort} ${dayDate}`;
    document.getElementById("subtitleDay2").textContent = `${dayShort} ${dayDate}`;

    document.getElementById("subtitleMes").textContent  = monthLong;
    document.getElementById("subtitleMes2").textContent = monthLong;

    document.getElementById("thDayLabel").textContent = `Día (${dayDate})`;
    document.getElementById("thMesLabel").textContent = `Mes (${monthLong})`;
  }

  // CSV parser (soporta comillas, comas, saltos)
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++){
      const c = text[i];
      const next = text[i+1];

      if (c === '"'){
        if (inQuotes && next === '"'){ cur += '"'; i++; }
        else { inQuotes = !inQuotes; }
        continue;
      }

      if (!inQuotes && c === ','){
        row.push(cur); cur = "";
        continue;
      }

      if (!inQuotes && (c === '\n' || c === '\r')){
        if (c === '\r' && next === '\n') i++;
        row.push(cur);
        rows.push(row);
        row = [];
        cur = "";
        continue;
      }

      cur += c;
    }

    if (cur.length || row.length){
      row.push(cur);
      rows.push(row);
    }

    return rows.filter(r => r.some(x => String(x).trim() !== ""));
  }

  function norm(s){ return String(s ?? "").trim(); }
  function lower(s){ return norm(s).toLowerCase(); }

  function toNumber(v){
    if (v === null || v === undefined) return null;
    let s = String(v).trim();
    if (!s) return null;

    s = s.replace("%","").trim();
    s = s.replace(/\./g, "");
    s = s.replace(",", ".");

    const n = Number(s);
    return Number.isNaN(n) ? null : n;
  }

  function isPercentLike(v){
    return String(v ?? "").includes("%");
  }

  function badgeForValue(val, isPercent){
    if (val === null) return { text: "s/d", cls: "pill warn" };

    if (isPercent){
      if (val >= 80) return { text: "OK", cls: "pill good" };
      if (val >= 40) return { text: "Atención", cls: "pill warn" };
      return { text: "Crítico", cls: "pill bad" };
    }

    return { text: "ver", cls: "pill warn" };
  }

  async function fetchData(){
    setStatus("consultando…");

    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("No se pudo leer el CSV publicado (revisar publicación/permisos/gid).");

    const csv = await res.text();
    const table = parseCSV(csv);
    if (table.length < 2) throw new Error("El CSV no trae datos (hoja vacía o rango publicado sin contenido).");

    const headers = table[0].map(norm);
    const dataRows = table.slice(1);

    const hLower = headers.map(h => lower(h));
    const idxIndic = hLower.findIndex(h => h.includes("indic"));
    const idxDia   = hLower.findIndex(h => h.includes("día") || h.includes("dia") || h.includes("diario"));
    const idxMes   = hLower.findIndex(h => h.includes("mes") || h.includes("mensual") || h.includes("acum") || h.includes("acumul"));

    let iIndic = idxIndic !== -1 ? idxIndic : 0;
    let iDia   = idxDia   !== -1 ? idxDia   : 1;
    let iMes   = idxMes   !== -1 ? idxMes   : (headers.length >= 3 ? 2 : 1);

    if (iDia === iIndic) iDia = (iIndic === 0 ? 1 : 0);
    if (iMes === iIndic || iMes === iDia){
      const candidates = [...headers.keys()].filter(i => i !== iIndic && i !== iDia);
      iMes = candidates[0] ?? iMes;
    }

    const dayLabel = headers[iDia] || "Día";
    const mesLabel = headers[iMes] || "Mes";

    const items = dataRows
      .map(r => {
        const indicador = norm(r[iIndic]);
        const diaRaw = norm(r[iDia]);
        const mesRaw = norm(r[iMes]);
        return {
          indicador,
          diaRaw,
          mesRaw,
          dia: toNumber(diaRaw),
          mes: toNumber(mesRaw),
          pctDia: isPercentLike(diaRaw),
          pctMes: isPercentLike(mesRaw)
        };
      })
      .filter(x => x.indicador);

    if (!items.length) throw new Error("No se pudieron construir items: revisá la columna del indicador.");

    return { items, dayLabel, mesLabel };
  }

  function renderKPIs(items, mode){
    const grid = document.getElementById(mode === "day" ? "kpiGridDay" : "kpiGridMes");
    grid.innerHTML = "";

    items.slice(0, 8).forEach(it => {
      const raw = mode === "day" ? it.diaRaw : it.mesRaw;
      const val = mode === "day" ? it.dia : it.mes;
      const pct = mode === "day" ? it.pctDia : it.pctMes;

      const badge = badgeForValue(val, pct);
      const valText = raw === "" ? "—" : raw;

      const div = document.createElement("div");
      div.className = "kpi";
      div.innerHTML = `
        <div class="name">${it.indicador}</div>
        <div class="val">${valText}</div>
        <div class="sub">
          <span class="${badge.cls}">${badge.text}</span>
        </div>
      `;
      grid.appendChild(div);
    });
  }

  function renderTable(items, mode){
    const body = document.getElementById(mode === "day" ? "detailBodyDay" : "detailBodyMes");
    body.innerHTML = "";

    items.forEach(it => {
      const raw = mode === "day" ? it.diaRaw : it.mesRaw;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.indicador}</td>
        <td class="right">${raw === "" ? "—" : raw}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderCompareChart(items, dayLabel, mesLabel){
    const slice = items.slice(0, 12);

    const labels = [];
    const daySeries = [];
    const mesSeries = [];

    for (const x of slice){
      const d = Number.isFinite(x.dia) ? x.dia : null;
      const m = Number.isFinite(x.mes) ? x.mes : null;

      if (d === null && m === null) continue;

      labels.push(x.indicador);
      daySeries.push(d);
      mesSeries.push(m);
    }

    if (!labels.length){
      if (chartCompare) { chartCompare.destroy(); chartCompare = null; }
      showChartMsg("No hay valores numéricos suficientes para graficar (revisá que Día/Mes sean números o porcentajes).");
      return;
    }

    hideChartMsg();

    const ctx = document.getElementById("chartCompare").getContext("2d");
    if (chartCompare) chartCompare.destroy();

    chartCompare = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: dayLabel, data: daySeries },
          { label: mesLabel, data: mesSeries }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        layout: { padding: { top: 6, right: 10, bottom: 18, left: 10 } },
        plugins: {
          legend: { labels: { color: "rgba(234,241,255,.92)" } },
          tooltip: {
            callbacks: {
              label: (c) => `${c.dataset.label}: ${c.raw === null ? "—" : c.raw}`
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: "rgba(234,241,255,.72)",
              align: "center",
              autoSkip: false,
              maxRotation: 20,
              minRotation: 0,
              padding: 8,
              callback: function(value) {
                const label = String(this.getLabelForValue(value) ?? "");

                // cortes preferidos
                const preferred = [" vs ", " de ", " para "];
                for (const sep of preferred) {
                  if (label.includes(sep) && label.length > 18) {
                    const parts = label.split(sep);
                    if (parts.length >= 2) {
                      return [
                        parts[0].trim(),
                        (sep.trim() + " " + parts.slice(1).join(sep).trim())
                      ];
                    }
                  }
                }

                // fallback: wrap por longitud (máx 2 líneas)
                const max = 18;
                if (label.length <= max) return label;

                const words = label.split(" ");
                const lines = [];
                let cur = "";

                for (const w of words) {
                  const next = (cur ? cur + " " : "") + w;
                  if (next.length <= max) cur = next;
                  else {
                    if (cur) lines.push(cur);
                    cur = w;
                  }
                  if (lines.length === 2) break;
                }
                if (cur && lines.length < 2) lines.push(cur);

                return lines;
              }
            },
            grid: { color: "rgba(255,255,255,.10)" }
          },
          y: {
            ticks: { color: "rgba(234,241,255,.72)" },
            grid: { color: "rgba(255,255,255,.10)" }
          }
        }
      }
    });
  }

  async function refresh(){
    try{
      setAutoPeriodLabels();

      hideHelp("day");
      hideHelp("mes");
      hideChartMsg();

      const { items, dayLabel, mesLabel } = await fetchData();

      renderKPIs(items, "day");
      renderTable(items, "day");

      renderKPIs(items, "mes");
      renderTable(items, "mes");

      renderCompareChart(items, dayLabel, mesLabel);

      setStatus("ok");
      setLastUpdate(new Date());
    } catch (err){
      console.error(err);
      setStatus("error: " + err.message);

      const isFile = location.protocol === "file:";
      const helpHtml = `
        <div><strong>Checklist rápido</strong></div>
        <ol style="margin:8px 0 0 18px;padding:0;">
          <li>Si abriste el archivo como <code>file:///</code>, servilo por HTTP:</li>
        </ol>
        <div style="margin-left:18px;">
          <div>• VSCode → extensión “Live Server”</div>
          <div>• o: <code>python -m http.server 8000</code> y abrís <code>http://localhost:8000</code></div>
        </div>
        <div style="margin-top:10px;">
          <div>2) Si no trae datos, probá cambiar <code>GID</code> (0, 1, 2…).</div>
        </div>
        ${isFile ? `<div style="margin-top:10px;">Detecté <code>file:///</code>: eso suele bloquear <code>fetch()</code>.</div>` : ``}
        <div style="margin-top:10px;">
          <div>3) Verificación directa: abrí en el navegador la URL:</div>
          <div style="margin-top:6px;"><code>${CSV_URL}</code></div>
          <div style="margin-top:6px;">Debería verse texto CSV (comas). Si ves HTML, no está bien publicado o el gid no corresponde.</div>
        </div>
      `;
      showHelp("day", helpHtml);
      showHelp("mes", helpHtml);
      showChartMsg("No se pudo cargar el gráfico porque falló la lectura del CSV. Revisá publicación/permisos/gid o serví por HTTP si estás en file://.");
    }
  }

  // Auto refresh
  let timer;
  function startTimer(){
    if (timer) clearInterval(timer);
    const sec = Math.max(5, Number(document.getElementById("refreshSec").value) || 30);
    timer = setInterval(refresh, sec * 1000);
  }

  document.getElementById("btnNow").addEventListener("click", () => refresh());
  document.getElementById("refreshSec").addEventListener("change", () => startTimer());

  setAutoPeriodLabels();
  refresh();
  startTimer();
</script>
</body>
</html>

