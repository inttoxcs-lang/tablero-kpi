<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tablero KPI - Transporte San Jos√© S.A (Tr√°fico)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --muted:#8fa3c0;
      --text:#eaf1ff;
      --border:rgba(255,255,255,.18);

      --good:#29d391;
      --warn:#ffd166;
      --bad:#ff5c7a;

      --goodB:rgba(41,211,145,.55);
      --warnB:rgba(255,209,102,.45);
      --badB: rgba(255,92,122,.55);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:#000; /* m√°rgenes */
      position:relative;
      overflow-x:hidden;
    }

    /* üá¶üá∑ Bandera COMPLETA y sin oscurecer (PNG para colores m√°s vivos) */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-2;
      background-image:url("https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Flag_of_Argentina.svg/1920px-Flag_of_Argentina.svg.png");
      background-repeat:no-repeat;
      background-position:center center;
      background-size:contain;     /* bandera completa */
      background-color:#000;       /* m√°rgenes */
      opacity:1;                   /* sin opacidad */
      filter:none;                 /* sin filtros */
      pointer-events:none;
    }

    /* sin overlay */
    body::after{ display:none; }

    header{
      padding:18px 22px;
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:10;
      /* m√°s transparente para que se vea la bandera */
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(4px);
    }

    h1{ margin:0; font-size:18px; }

    .meta{
      font-size:12px;
      color:#ffffff;
      display:flex;
      gap:16px;
      align-items:center;
      text-shadow:0 1px 2px rgba(0,0,0,.6);
    }

    .wrap{ padding:18px 22px 28px; max-width:1200px; margin:0 auto; }

    .grid2{
      display:grid;
      gap:14px;
      grid-template-columns:1fr 1fr;
    }
    @media (max-width:960px){ .grid2{ grid-template-columns:1fr; } }

    .card{
      /* muy transparente para que el fondo se vea */
      background: rgba(0,0,0,.25);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      backdrop-filter: blur(4px);
    }

    .card h2{
      margin:0 0 10px;
      font-size:14px;
      color:#fff;
      text-shadow:0 1px 2px rgba(0,0,0,.6);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .subtitle{ font-size:12px; color:#fff; opacity:.85; }

    .kpi-grid{
      display:grid;
      gap:10px;
      grid-template-columns:repeat(4, minmax(0,1fr));
    }
    @media (max-width:960px){ .kpi-grid{ grid-template-columns:repeat(2,1fr); } }

    .kpi{
      padding:12px;
      border-radius:12px;
      /* m√°s transparente todav√≠a */
      background:rgba(0,0,0,.20);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      min-height:136px;
      backdrop-filter: blur(2px);
    }

    .kpi .name{
      font-size:12px;
      color:#fff;
      opacity:.9;
      margin-bottom:10px;
      text-shadow:0 1px 2px rgba(0,0,0,.6);
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      line-height:1.2;
      min-height:2.4em;
    }

    .kpi .val{
      font-size:24px;
      font-weight:900;
      line-height:1;
      text-shadow:0 2px 4px rgba(0,0,0,.7);
    }

    .kpi .sub{
      margin-top:auto;
      font-size:12px;
      color:#fff;
      opacity:.9;
    }

    .pill{
      padding:2px 8px;
      border-radius:999px;
      font-weight:900;
      border:1px solid var(--border);
      background:rgba(0,0,0,.20);
      text-shadow:0 1px 2px rgba(0,0,0,.6);
    }

    .pill.good{ color:var(--good); }
    .pill.warn{ color:var(--warn); }
    .pill.bad{ color:var(--bad); }

    .row{
      display:grid;
      gap:14px;
      grid-template-columns:1fr 1fr;
      margin-top:14px;
    }
    @media (max-width:960px){ .row{ grid-template-columns:1fr; } }

    canvas{ width:100%!important; height:320px!important; }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:rgba(0,0,0,.22);
      backdrop-filter: blur(4px);
    }

    th,td{
      padding:10px;
      border-bottom:1px solid var(--border);
      color:#fff;
      text-shadow:0 1px 2px rgba(0,0,0,.6);
    }

    th{ background:rgba(0,0,0,.25); }

    td.right{ text-align:right; }
    tr:last-child td{ border-bottom:none; }

    /* GIF arriba de todo */
    #gifCenter{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      pointer-events:none;
    }
    #gifCenter img{
      max-width:420px;
      width:35vw;
      min-width:220px;
      border-radius:12px;
      box-shadow:0 20px 60px rgba(0,0,0,.8);
    }

    /* Bot√≥n m√∫sica */
    #musicBtn{
      position:fixed;
      bottom:20px;
      right:20px;
      z-index:10000;
      background:rgba(0,0,0,.55);
      color:#fff;
      border:1px solid rgba(255,255,255,.45);
      border-radius:999px;
      padding:10px 14px;
      font-size:14px;
      cursor:pointer;
      backdrop-filter: blur(6px);
      text-shadow:0 1px 2px rgba(0,0,0,.6);
    }

    /* YouTube fuera de pantalla (NO display:none) */
    #ytHost{
      position:fixed;
      left:-9999px;
      top:-9999px;
      width:1px;
      height:1px;
      overflow:hidden;
    }
  </style>
</head>

<body>

<header>
  <h1>Tablero KPI - Transporte San Jos√© S.A</h1>
  <div class="meta">
    <div>Estado: <span id="status">‚Äî</span></div>
    <div>Actualizado: <span id="lastUpdate">‚Äî</span></div>
  </div>
</header>

<div class="wrap">

  <div class="grid2">
    <div class="card">
      <h2>KPIs del D√≠a <span class="subtitle">D√≠a</span></h2>
      <div id="kpiDay" class="kpi-grid"></div>
    </div>

    <div class="card">
      <h2>KPIs Acumulado Mes <span class="subtitle">Mes</span></h2>
      <div id="kpiMonth" class="kpi-grid"></div>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h2>Comparativo D√≠a vs Mes</h2>
      <canvas id="barChart"></canvas>
    </div>

    <div class="card">
      <h2>Detalle</h2>
      <table>
        <thead>
          <tr>
            <th>Indicador</th>
            <th class="right">D√≠a</th>
            <th class="right">Mes</th>
          </tr>
        </thead>
        <tbody id="detailBody"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- GIF Maradona -->
<div id="gifCenter">
  <img src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExcXY2Mmxpb2s2NThkMDNnNzV4enh5MGd0Z2R6azV1M3F4bDF4dTZ6bSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/hSogTpRXbb8bhNWV3r/giphy.gif" alt="Maradona">
</div>

<!-- M√∫sica -->
<button id="musicBtn">‚ñ∂ M√∫sica</button>
<div id="ytHost"><div id="ytPlayer"></div></div>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
const PUBLISHED_KEY="2PACX-1vQ6GRrP2Qr38OV2puOeVMdHQz6-7Oy1zhHWGyx1p5woGJRa0FBws02pPIMUDhTEVMuKKrn3j32TF2xX";
const CSV_URL=`https://docs.google.com/spreadsheets/d/e/${PUBLISHED_KEY}/pub?output=csv&gid=0`;

const YT_VIDEO_ID = "eVTXPUF4Oz4";

const RULES=[
 {match:/cumplimiento/i,type:"min",green:98,yellow:95},
 {match:/titularidad/i,type:"min",green:95,yellow:92},
 {match:/siniestros|reclamos/i,type:"max",green:0,yellow:1},
 {match:/ipk/i,type:"min",green:0.6,yellow:0.55}
];

let barChart;
let ytPlayer=null, ytReady=false, ytPlaying=false;

function toNumber(v){
  if(v===undefined || v===null) return null;
  let s=String(v).trim();
  if(!s) return null;
  if(s.includes("%")) s=s.replace("%","").trim();
  s = s.replace(/\./g,"").replace(",",".");

  const n=Number(s);
  return Number.isNaN(n)?null:n;
}

function format(v){
  if(v===""||v==null) return "‚Äî";
  const s = String(v).trim();
  if(!s) return "‚Äî";
  if(s.includes("%")){
    const n = toNumber(s);
    return (n===null) ? s : (Math.round(n) + "%");
  }
  const n=toNumber(s);
  if(n===null) return s;
  if(Number.isInteger(n)) return String(n);
  return n.toFixed(2).replace(".",",");
}

function status(ind,val){
  let r=RULES.find(x=>x.match.test(ind));
  if(!r||val===null) return "warn";
  if(r.type==="min"){
    if(val>=r.green) return "good";
    if(val>=r.yellow) return "warn";
    return "bad";
  }else{
    if(val<=r.green) return "good";
    if(val<=r.yellow) return "warn";
    return "bad";
  }
}

function ensureChart(labels, dayData, monData){
  const ctx = document.getElementById("barChart");
  if(barChart){
    barChart.data.labels = labels;
    barChart.data.datasets[0].data = dayData;
    barChart.data.datasets[1].data = monData;
    barChart.update();
    return;
  }
  barChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "D√≠a", data: dayData },
        { label: "Mes", data: monData }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: "#cfe0ff" } } },
      scales: {
        x: { ticks: { color: "#cfe0ff" }, grid: { color: "rgba(255,255,255,.06)" } },
        y: { ticks: { color: "#cfe0ff" }, grid: { color: "rgba(255,255,255,.06)" } }
      }
    }
  });
}

function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  return lines.map(line => line.split(","));
}

/* YouTube */
function onYouTubeIframeAPIReady(){
  ytPlayer = new YT.Player("ytPlayer", {
    videoId: YT_VIDEO_ID,
    playerVars: { autoplay: 0, controls: 0, rel: 0, playsinline: 1 },
    events: {
      onReady: () => { ytReady = true; },
      onStateChange: (e) => {
        if(e.data === YT.PlayerState.PLAYING) ytPlaying = true;
        if(e.data === YT.PlayerState.PAUSED || e.data === YT.PlayerState.ENDED) ytPlaying = false;
        document.getElementById("musicBtn").textContent = ytPlaying ? "‚è∏ M√∫sica" : "‚ñ∂ M√∫sica";
      }
    }
  });
}

async function refresh(){
  try{
    const res=await fetch(CSV_URL+"&_="+Date.now());
    const csv = await res.text();

    const rows = parseCSV(csv);
    const data = rows.slice(1).map(r => ({
      ind: (r[0] ?? "").trim(),
      day: r[1] ?? "",
      mon: r[2] ?? "",
      d: toNumber(r[1]),
      m: toNumber(r[2])
    })).filter(x => x.ind.length);

    document.getElementById("kpiDay").innerHTML="";
    document.getElementById("kpiMonth").innerHTML="";
    document.getElementById("detailBody").innerHTML="";

    let anyCritical = false;

    data.forEach(it=>{
      const sd = status(it.ind, it.d);
      if(sd==="bad") anyCritical = true;

      const divD=document.createElement("div");
      divD.className="kpi";
      divD.style.borderColor= sd==="good"? "var(--goodB)":sd==="bad"?"var(--badB)":"var(--warnB)";
      divD.innerHTML=`
        <div class="name">${it.ind}</div>
        <div class="val">${format(it.day)}</div>
        <div class="sub"><span class="pill ${sd}">${sd==="good"?"OK":sd==="bad"?"Cr√≠tico":"Atenci√≥n"}</span></div>`;
      document.getElementById("kpiDay").appendChild(divD);

      const sm = status(it.ind, it.m);
      if(sm==="bad") anyCritical = true;

      const divM=document.createElement("div");
      divM.className="kpi";
      divM.style.borderColor= sm==="good"? "var(--goodB)":sm==="bad"?"var(--badB)":"var(--warnB)";
      divM.innerHTML=`
        <div class="name">${it.ind}</div>
        <div class="val">${format(it.mon)}</div>
        <div class="sub"><span class="pill ${sm}">${sm==="good"?"OK":sm==="bad"?"Cr√≠tico":"Atenci√≥n"}</span></div>`;
      document.getElementById("kpiMonth").appendChild(divM);

      document.getElementById("detailBody").innerHTML +=
        `<tr><td>${it.ind}</td><td class="right">${format(it.day)}</td><td class="right">${format(it.mon)}</td></tr>`;
    });

    document.getElementById("gifCenter").style.display = anyCritical ? "flex" : "none";

    ensureChart(
      data.map(x=>x.ind),
      data.map(x=>(x.d ?? 0)),
      data.map(x=>(x.m ?? 0))
    );

    document.getElementById("status").textContent="OK";
    document.getElementById("lastUpdate").textContent=new Date().toLocaleString("es-AR");

  }catch(e){
    document.getElementById("status").textContent="ERROR";
    console.error(e);
  }
}

refresh();
setInterval(refresh,30000);

/* Bot√≥n m√∫sica */
document.getElementById("musicBtn").addEventListener("click", () => {
  if(!ytReady || !ytPlayer) return;
  if(!ytPlaying) ytPlayer.playVideo();
  else ytPlayer.pauseVideo();
});
</script>

</body>
</html>
