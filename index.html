<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tablero KPI - Google Sheets (Día + Mes + comparativo)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --muted:#8fa3c0;
      --text:#eaf1ff;
      --border:rgba(255,255,255,.08);
      --good:#29d391;
      --warn:#ffd166;
      --bad:#ff5c7a;
      --focus: rgba(207,224,255,.65);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% 0%, #132043 0%, var(--bg) 55%);
      color: var(--text);
      font-size: 14px;
    }

    header{
      padding:18px 22px;
      display:flex; align-items: baseline; justify-content: space-between; gap: 12px;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(8px);
      position: sticky; top: 0;
      background: rgba(11,18,32,.55);
      z-index: 10;
    }
    h1{ margin:0; font-size:18px; letter-spacing:.2px; }

    .meta{
      color: var(--muted);
      font-size:12px;
      display:flex; gap:16px; flex-wrap: wrap; align-items:center;
    }
    .controls{ display:flex; gap:10px; align-items:center; }
    .controls label{ font-size:12px; color: var(--muted); }
    input[type="number"]{
      width:110px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      outline:none;
    }
    button{
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 650;
    }
    button:hover{ background: rgba(255,255,255,.09); }

    button:focus-visible,
    input:focus-visible{
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }

    .wrap{ padding: 18px 22px 28px; max-width: 1200px; margin: 0 auto; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
    }
    .card h2{ margin:0 0 10px; font-size:14px; color:#cfe0ff; font-weight:650; }

    .kpi-grid{
      display:grid; gap:10px;
      grid-template-columns: repeat(4, minmax(0,1fr));
      align-items: stretch; /* asegura alturas consistentes */
    }
    @media (max-width: 960px){
      .kpi-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    /* KPI cards alineadas y ordenadas */
    .kpi{
      padding:12px;
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);

      display:flex;
      flex-direction: column;
      justify-content: space-between;

      min-height: 140px; /* CLAVE: todas iguales */
    }
    .kpi .name{
      font-size:12px;
      color: var(--muted);
      margin-bottom: 6px;
      min-height: 32px; /* reserva espacio para títulos largos */
    }
    .kpi .val{
      font-size:22px;
      font-weight:750;
      letter-spacing:.2px;
    }
    .kpi .sub{
      margin-top:10px;
      font-size:12px;
      color: var(--muted);
      display:flex;
      justify-content: flex-end; /* estado siempre abajo a la derecha */
      align-items:center;
    }

    .pill{ padding:2px 8px; border-radius: 999px; font-weight:650; border: 1px solid var(--border); }
    .pill.good{ color: var(--good); }
    .pill.warn{ color: var(--warn); }
    .pill.bad{ color: var(--bad); }

    .row{
      display:grid; gap:14px;
      grid-template-columns: 1fr 1fr;
      margin-top: 0;
    }
    @media (max-width: 960px){
      .row{ grid-template-columns: 1fr; }
    }

    .full-row{
      margin-top: 14px;
    }

    canvas{ width:100% !important; height: 360px !important; }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      overflow:hidden;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    th, td{ padding:10px; border-bottom: 1px solid var(--border); }
    th{ text-align:left; color:#cfe0ff; background: rgba(255,255,255,.03); }
    td{ color: var(--text); }
    tr:last-child td{ border-bottom:none; }
    tr:hover td{ background: rgba(255,255,255,.02); }
    .right{ text-align:right; }
    .muted{ color: var(--muted); }

    .alert{
      margin-top:10px;
      padding:10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      word-break: break-word;
    }
    code{ color:#cfe0ff; }
  </style>
</head>

<body>
<header>
  <div style="display:flex;gap:14px;align-items:baseline;flex-wrap:wrap;">
    <h1>Tablero KPI - Transporte San José S.A (Tráfico PRA)</h1>
  </div>

  <div class="meta">
    <div>Estado: <span id="status" class="muted">iniciando…</span></div>
    <div>Última actualización: <span id="lastUpdate" class="muted">—</span></div>
    <div class="controls">
      <label for="refreshSec">Refresh (s)</label>
      <input id="refreshSec" type="number" min="5" step="5" value="30" />
      <button id="btnNow" type="button">Actualizar</button>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- ARRIBA: DÍA + MES -->
  <div class="row">
    <section class="card">
      <h2>KPIs (Día)</h2>
      <div id="kpiGridDay" class="kpi-grid"></div>

      <h2 style="margin-top:14px;">Detalle (Día)</h2>
      <table>
        <thead>
          <tr>
            <th>Indicador</th>
            <th class="right" id="thDayLabel">Día</th>
          </tr>
        </thead>
        <tbody id="detailBodyDay"></tbody>
      </table>

      <div id="helpDay" class="alert" style="display:none;"></div>
    </section>

    <section class="card">
      <h2>KPIs (Mes)</h2>
      <div id="kpiGridMes" class="kpi-grid"></div>

      <h2 style="margin-top:14px;">Detalle (Mes)</h2>
      <table>
        <thead>
          <tr>
            <th>Indicador</th>
            <th class="right" id="thMesLabel">Mes</th>
          </tr>
        </thead>
        <tbody id="detailBodyMes"></tbody>
      </table>

      <div id="helpMes" class="alert" style="display:none;"></div>
    </section>
  </div>

  <!-- ABAJO: COMPARATIVO EN FILA COMPLETA -->
  <section class="card full-row">
    <h2>Comparativo (Día vs Mes)</h2>
    <canvas id="chartCompare"></canvas>
    <div id="chartMsg" class="alert" style="display:none;margin-top:10px;"></div>
    <div class="muted" style="margin-top:10px;font-size:12px;">
      Fuente: Google Sheets (publicado). Se reconsulta en cada refresh.
    </div>
  </section>

</div>

<script>
  // ============================================================================
  // CONFIG (TU PUBLICACIÓN)
  // ============================================================================
  const PUBLISHED_KEY = "2PACX-1vQ6GRrP2Qr38OV2puOeVMdHQz6-7Oy1zhHWGyx1p5woGJRa0FBws02pPIMUDhTEVMuKKrn3j32TF2xX";
  const GID = 0;
  const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_KEY}/pub?output=csv&gid=${GID}`;
  // ============================================================================

  let chartCompare;

  function setStatus(txt){ document.getElementById("status").textContent = txt; }
  function setLastUpdate(d){
    document.getElementById("lastUpdate").textContent = d ? d.toLocaleString("es-AR") : "—";
  }

  function showHelp(which, html){
    const el = document.getElementById(which === "day" ? "helpDay" : "helpMes");
    el.style.display = "block";
    el.innerHTML = html;
  }
  function hideHelp(which){
    const el = document.getElementById(which === "day" ? "helpDay" : "helpMes");
    el.style.display = "none";
    el.innerHTML = "";
  }

  function showChartMsg(html){
    const el = document.getElementById("chartMsg");
    el.style.display = "block";
    el.innerHTML = html;
  }
  function hideChartMsg(){
    const el = document.getElementById("chartMsg");
    el.style.display = "none";
    el.innerHTML = "";
  }

  // CSV parser (soporta comillas, comas, saltos)
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++){
      const c = text[i];
      const next = text[i+1];

      if (c === '"'){
        if (inQuotes && next === '"'){ cur += '"'; i++; }
        else { inQuotes = !inQuotes; }
        continue;
      }

      if (!inQuotes && c === ','){
        row.push(cur); cur = "";
        continue;
      }

      if (!inQuotes && (c === '\n' || c === '\r')){
        if (c === '\r' && next === '\n') i++;
        row.push(cur);
        rows.push(row);
        row = [];
        cur = "";
        continue;
      }

      cur += c;
    }

    if (cur.length || row.length){
      row.push(cur);
      rows.push(row);
    }

    return rows.filter(r => r.some(x => String(x).trim() !== ""));
  }

  function norm(s){ return String(s ?? "").trim(); }
  function lower(s){ return norm(s).toLowerCase(); }

  function toNumber(v){
    if (v === null || v === undefined) return null;
    let s = String(v).trim();
    if (!s) return null;

    // % -> se conserva como 0-100
    s = s.replace("%","").trim();

    // 1.234,56 -> 1234.56
    s = s.replace(/\./g, "");
    s = s.replace(",", ".");

    const n = Number(s);
    return Number.isNaN(n) ? null : n;
  }

  function isPercentLike(v){
    return String(v ?? "").includes("%");
  }

  function badgeForValue(val){
    if (val === null) return { text: "s/d", cls: "pill warn" };
    if (Math.abs(val) < 0.01) return { text: "OK", cls: "pill good" };
    return { text: "ver", cls: "pill warn" };
  }

  async function fetchData(){
    setStatus("consultando…");

    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("No se pudo leer el CSV publicado (revisar publicación/permisos/gid).");

    const csv = await res.text();
    const table = parseCSV(csv);
    if (table.length < 2) throw new Error("El CSV no trae datos (hoja vacía o rango publicado sin contenido).");

    const headers = table[0].map(norm);
    const dataRows = table.slice(1);

    // Detección por nombre
    const hLower = headers.map(h => lower(h));

    const idxIndic = hLower.findIndex(h => h.includes("indic"));
    const idxDia   = hLower.findIndex(h => h.includes("día") || h.includes("dia") || h.includes("diario"));
    const idxMes   = hLower.findIndex(h => h.includes("mes") || h.includes("mensual") || h.includes("acum") || h.includes("acumul"));

    let iIndic = idxIndic !== -1 ? idxIndic : 0;
    let iDia   = idxDia   !== -1 ? idxDia   : 1;
    let iMes   = idxMes   !== -1 ? idxMes   : (headers.length >= 3 ? 2 : 1);

    // Resolver colisiones
    if (iDia === iIndic) iDia = (iIndic === 0 ? 1 : 0);
    if (iMes === iIndic || iMes === iDia){
      const candidates = [...headers.keys()].filter(i => i !== iIndic && i !== iDia);
      iMes = candidates[0] ?? iMes;
    }

    const dayLabel = headers[iDia] || "Día";
    const mesLabel = headers[iMes] || "Mes";

    const items = dataRows
      .map(r => {
        const indicador = norm(r[iIndic]);
        const diaRaw = norm(r[iDia]);
        const mesRaw = norm(r[iMes]);
        return {
          indicador,
          diaRaw,
          mesRaw,
          dia: toNumber(diaRaw),
          mes: toNumber(mesRaw),
          pctDia: isPercentLike(diaRaw),
          pctMes: isPercentLike(mesRaw)
        };
      })
      .filter(x => x.indicador);

    if (!items.length) throw new Error("No se pudieron construir items: revisá la columna del indicador.");

    return { items, dayLabel, mesLabel };
  }

  function renderKPIs(items, mode){
    const grid = document.getElementById(mode === "day" ? "kpiGridDay" : "kpiGridMes");
    grid.innerHTML = "";

    items.slice(0, 8).forEach(it => {
      const raw = mode === "day" ? it.diaRaw : it.mesRaw;
      const val = mode === "day" ? it.dia : it.mes;
      const pct = mode === "day" ? it.pctDia : it.pctMes;

      const badge = badgeForValue(val);
      const valText = raw === "" ? "—" : (pct ? `${val ?? "—"}%` : raw);

      const div = document.createElement("div");
      div.className = "kpi";
      div.innerHTML = `
        <div class="name">${it.indicador}</div>
        <div class="val">${valText}</div>
        <div class="sub">
          <span class="${badge.cls}">${badge.text}</span>
        </div>
      `;
      grid.appendChild(div);
    });
  }

  function renderTable(items, mode){
    const body = document.getElementById(mode === "day" ? "detailBodyDay" : "detailBodyMes");
    body.innerHTML = "";

    items.forEach(it => {
      const raw = mode === "day" ? it.diaRaw : it.mesRaw;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.indicador}</td>
        <td class="right">${raw === "" ? "—" : raw}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderCompareChart(items, dayLabel, mesLabel){
    const slice = items.slice(0, 12);

    const labels = [];
    const daySeries = [];
    const mesSeries = [];

    for (const x of slice){
      const d = Number.isFinite(x.dia) ? x.dia : null;
      const m = Number.isFinite(x.mes) ? x.mes : null;

      if (d === null && m === null) continue;

      labels.push(x.indicador);
      daySeries.push(d);
      mesSeries.push(m);
    }

    if (!labels.length){
      if (chartCompare) { chartCompare.destroy(); chartCompare = null; }
      showChartMsg("No hay valores numéricos suficientes para graficar (revisá que Día/Mes sean números o porcentajes).");
      return;
    }

    hideChartMsg();

    const ctx = document.getElementById("chartCompare").getContext("2d");
    if (chartCompare) chartCompare.destroy();

    chartCompare = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: dayLabel, data: daySeries },
          { label: mesLabel, data: mesSeries }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: {
          legend: { labels: { color: "#eaf1ff" } },
          tooltip: {
            callbacks: {
              label: (c) => `${c.dataset.label}: ${c.raw === null ? "—" : c.raw}`
            }
          }
        },
        scales: {
          x: { ticks: { color: "#8fa3c0" }, grid: { color: "rgba(255,255,255,.06)" } },
          y: { ticks: { color: "#8fa3c0" }, grid: { color: "rgba(255,255,255,.06)" } }
        }
      }
    });
  }

  async function refresh(){
    try{
      hideHelp("day");
      hideHelp("mes");
      hideChartMsg();

      const { items, dayLabel, mesLabel } = await fetchData();

      document.getElementById("thDayLabel").textContent = dayLabel;
      document.getElementById("thMesLabel").textContent = mesLabel;

      renderKPIs(items, "day");
      renderTable(items, "day");

      renderKPIs(items, "mes");
      renderTable(items, "mes");

      renderCompareChart(items, dayLabel, mesLabel);

      setStatus("ok");
      setLastUpdate(new Date());
    } catch (err){
      console.error(err);
      setStatus("error: " + err.message);

      showChartMsg("No se pudo cargar el gráfico porque falló la lectura del CSV. Revisá publicación/permisos/gid o serví por HTTP si estás en file://. Si estás en GitHub Pages y falla igual, verificá que la URL de Google Sheets devuelva CSV real.");

      const isFile = location.protocol === "file:";
      const helpHtml = `
        <div><strong>Checklist rápido</strong></div>
        <ol style="margin:8px 0 0 18px;padding:0;">
          <li>Si abriste el archivo como <code>file:///</code>, servilo por HTTP:</li>
        </ol>
        <div style="margin-left:18px;">
          <div>• VSCode → extensión “Live Server”</div>
          <div>• o: <code>python -m http.server 8000</code> y abrís <code>http://localhost:8000</code></div>
        </div>
        <div style="margin-top:10px;">
          <div>2) Si no trae datos, probá cambiar <code>GID</code> (0, 1, 2…).</div>
        </div>
        ${isFile ? `<div style="margin-top:10px;">Detecté <code>file:///</code>: eso suele bloquear <code>fetch()</code>.</div>` : ``}
        <div style="margin-top:10px;">
          <div>3) Verificación directa: abrí en el navegador la URL:</div>
          <div style="margin-top:6px;"><code>${CSV_URL}</code></div>
          <div style="margin-top:6px;">Debería verse texto CSV (comas). Si ves HTML, no está bien publicado o el gid no corresponde.</div>
        </div>
      `;
      showHelp("day", helpHtml);
      showHelp("mes", helpHtml);
    }
  }

  // Auto refresh
  let timer;
  function startTimer(){
    if (timer) clearInterval(timer);
    const sec = Math.max(5, Number(document.getElementById("refreshSec").value) || 30);
    timer = setInterval(refresh, sec * 1000);
  }

  document.getElementById("btnNow").addEventListener("click", () => refresh());
  document.getElementById("refreshSec").addEventListener("change", () => startTimer());

  refresh();
  startTimer();
</script>
</body>
</html>
