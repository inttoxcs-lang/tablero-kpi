<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tablero KPI - Transporte San José S.A (Tráfico)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --muted:#8fa3c0;
      --text:#eaf1ff;
      --border:rgba(255,255,255,.08);

      --good:#29d391;
      --warn:#ffd166;
      --bad:#ff5c7a;

      --goodB:rgba(41,211,145,.45);
      --warnB:rgba(255,209,102,.35);
      --badB: rgba(255,92,122,.45);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 800px at 20% 0%, #132043 0%, var(--bg) 55%);
      color:var(--text);
    }
    header{
      padding:18px 22px;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(8px);
      position:sticky; top:0;
      background: rgba(11,18,32,.55);
      z-index:10;
    }
    h1{ margin:0; font-size:18px; }
    .meta{
      color:var(--muted);
      font-size:12px;
      display:flex;
      gap:16px;
      align-items:center;
    }

    .wrap{ padding:18px 22px 28px; max-width:1200px; margin:0 auto; }

    .grid2{
      display:grid;
      gap:14px;
      grid-template-columns:1fr 1fr;
    }
    @media (max-width:960px){ .grid2{ grid-template-columns:1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 28px rgba(0,0,0,.25);
    }
    .card h2{
      margin:0 0 10px;
      font-size:14px;
      color:#cfe0ff;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .subtitle{
      font-size:12px;
      color:var(--muted);
    }

    .kpi-grid{
      display:grid;
      gap:10px;
      grid-template-columns:repeat(4, minmax(0,1fr));
      align-items:stretch;
    }
    @media (max-width:960px){ .kpi-grid{ grid-template-columns:repeat(2,1fr); } }

    .kpi{
      padding:12px;
      border-radius:12px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      min-height:136px;
    }
    .kpi .name{
      font-size:12px;
      color:var(--muted);
      min-height:2.4em;
      line-height:1.2;
      margin-bottom:10px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .kpi .val{
      font-size:24px;
      font-weight:800;
      line-height:1;
    }
    .kpi .sub{
      margin-top:auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:var(--muted);
    }

    .pill{
      padding:2px 8px;
      border-radius:999px;
      font-weight:800;
      border:1px solid var(--border);
    }
    .pill.good{ color:var(--good); }
    .pill.warn{ color:var(--warn); }
    .pill.bad{ color:var(--bad); }

    .row{
      display:grid;
      gap:14px;
      grid-template-columns:1fr 1fr;
      margin-top:14px;
    }
    @media (max-width:960px){ .row{ grid-template-columns:1fr; } }

    canvas{ width:100%!important; height:320px!important; }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid var(--border);
    }
    th,td{
      padding:10px;
      border-bottom:1px solid var(--border);
    }
    th{
      background:rgba(255,255,255,.03);
      color:#cfe0ff;
      text-align:left;
    }
    td.right{ text-align:right; }
    tr:last-child td{ border-bottom:none; }

    /* ===========================
       GIF CENTRADO (OVERLAY)
       =========================== */
    #gifCenter{
      position: fixed;
      inset: 0;
      display: none;               /* default oculto */
      align-items: center;
      justify-content: center;
      z-index: 9999;
      pointer-events: none;        /* no bloquea clicks */
    }
    #gifCenter img{
      max-width: 420px;
      width: 35vw;
      min-width: 220px;
      opacity: 0.9;
      border-radius: 12px;
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
    }
  </style>
</head>

<body>
<header>
  <h1>Tablero KPI - Transporte San José S.A</h1>
  <div class="meta">
    <div>Estado: <span id="status">—</span></div>
    <div>Actualizado: <span id="lastUpdate">—</span></div>
  </div>
</header>

<div class="wrap">

  <!-- KPIs Día / Mes -->
  <div class="grid2">
    <div class="card">
      <h2>KPIs del Día <span class="subtitle">Día</span></h2>
      <div id="kpiDay" class="kpi-grid"></div>
    </div>

    <div class="card">
      <h2>KPIs Acumulado Mes <span class="subtitle">Mes</span></h2>
      <div id="kpiMonth" class="kpi-grid"></div>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h2>Comparativo Día vs Mes</h2>
      <canvas id="barChart"></canvas>
    </div>

    <div class="card">
      <h2>Detalle</h2>
      <table>
        <thead>
          <tr>
            <th>Indicador</th>
            <th class="right">Día</th>
            <th class="right">Mes</th>
          </tr>
        </thead>
        <tbody id="detailBody"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- GIF central (poner 200.gif en la misma carpeta que este HTML) -->
<div id="gifCenter">
  <img src="200.gif" alt="GIF centrado">
</div>

<script>
const PUBLISHED_KEY="2PACX-1vQ6GRrP2Qr38OV2puOeVMdHQz6-7Oy1zhHWGyx1p5woGJRa0FBws02pPIMUDhTEVMuKKrn3j32TF2xX";
const CSV_URL=`https://docs.google.com/spreadsheets/d/e/${PUBLISHED_KEY}/pub?output=csv&gid=0`;

const RULES=[
 {match:/cumplimiento/i,type:"min",green:98,yellow:95},
 {match:/titularidad/i,type:"min",green:95,yellow:92},
 {match:/siniestros|reclamos/i,type:"max",green:0,yellow:1},
 {match:/ipk/i,type:"min",green:0.6,yellow:0.55}
];

let barChart;

function toNumber(v){
  if(v===undefined || v===null) return null;
  let s=String(v).trim();
  if(!s) return null;

  // Si viene con %
  if(s.includes("%")){
    s=s.replace("%","").trim();
  }

  // Normalización:
  // - Si viene "0,65" -> "0.65"
  // - Si viene "2.875.000,00" -> quitamos puntos de miles y reemplazamos coma por punto
  s = s.replace(/\./g,"").replace(",",".");
  const n=Number(s);
  return Number.isNaN(n)?null:n;
}

function format(v){
  if(v===""||v==null) return "—";
  const s = String(v).trim();
  if(!s) return "—";
  if(s.includes("%")){
    const n = toNumber(s);
    return (n===null) ? s : (Math.round(n) + "%");
  }
  const n=toNumber(s);
  if(n===null) return s;
  if(Number.isInteger(n)) return String(n);
  return n.toFixed(2).replace(".",",");
}

function status(ind,val){
  let r=RULES.find(x=>x.match.test(ind));
  if(!r || val===null) return "warn";
  if(r.type==="min"){
    if(val>=r.green) return "good";
    if(val>=r.yellow) return "warn";
    return "bad";
  }else{
    if(val<=r.green) return "good";
    if(val<=r.yellow) return "warn";
    return "bad";
  }
}

function ensureChart(labels, dayData, monData){
  const ctx = document.getElementById("barChart");
  if(barChart){
    barChart.data.labels = labels;
    barChart.data.datasets[0].data = dayData;
    barChart.data.datasets[1].data = monData;
    barChart.update();
    return;
  }
  barChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "Día", data: dayData },
        { label: "Mes", data: monData }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: "#cfe0ff" } }
      },
      scales: {
        x: { ticks: { color: "#cfe0ff" }, grid: { color: "rgba(255,255,255,.06)" } },
        y: { ticks: { color: "#cfe0ff" }, grid: { color: "rgba(255,255,255,.06)" } }
      }
    }
  });
}

async function refresh(){
  try{
    // Cache-busting
    const res=await fetch(CSV_URL+"&_="+Date.now());
    const csv = (await res.text()).trim();
    const rows = csv.split("\n").map(r => r.split(","));

    // Espera columnas: Indicador, Dia, Mes
    const data = rows.slice(1).map(r => ({
      ind: r[0],
      day: r[1],
      mon: r[2],
      d: toNumber(r[1]),
      m: toNumber(r[2])
    })).filter(x => x.ind && x.ind.trim().length);

    document.getElementById("kpiDay").innerHTML="";
    document.getElementById("kpiMonth").innerHTML="";
    document.getElementById("detailBody").innerHTML="";

    // Para estado global + GIF
    let allGood = true;

    data.forEach(it=>{
      // Día
      const sd = status(it.ind, it.d);
      if(sd !== "good") allGood = false;

      const divD=document.createElement("div");
      divD.className="kpi";
      divD.style.borderColor= sd==="good" ? "var(--goodB)" : sd==="bad" ? "var(--badB)" : "var(--warnB)";
      divD.innerHTML=`
        <div class="name">${it.ind}</div>
        <div class="val">${format(it.day)}</div>
        <div class="sub"><span class="pill ${sd}">${sd==="good"?"OK":sd==="bad"?"Crítico":"Atención"}</span></div>`;
      document.getElementById("kpiDay").appendChild(divD);

      // Mes
      const sm = status(it.ind, it.m);
      if(sm !== "good") allGood = false;

      const divM=document.createElement("div");
      divM.className="kpi";
      divM.style.borderColor= sm==="good" ? "var(--goodB)" : sm==="bad" ? "var(--badB)" : "var(--warnB)";
      divM.innerHTML=`
        <div class="name">${it.ind}</div>
        <div class="val">${format(it.mon)}</div>
        <div class="sub"><span class="pill ${sm}">${sm==="good"?"OK":sm==="bad"?"Crítico":"Atención"}</span></div>`;
      document.getElementById("kpiMonth").appendChild(divM);

      // Tabla detalle
      document.getElementById("detailBody").innerHTML +=
        `<tr><td>${it.ind}</td><td class="right">${format(it.day)}</td><td class="right">${format(it.mon)}</td></tr>`;
    });

    // Chart
    ensureChart(
      data.map(x=>x.ind),
      data.map(x=>(x.d ?? 0)),
      data.map(x=>(x.m ?? 0))
    );

    // Estado + fecha
    document.getElementById("status").textContent = allGood ? "OK" : "ATENCIÓN";
    document.getElementById("lastUpdate").textContent = new Date().toLocaleString("es-AR");

    // Mostrar GIF solo si todo está OK
    const gif = document.getElementById("gifCenter");
    gif.style.display = allGood ? "flex" : "none";

  }catch(e){
    document.getElementById("status").textContent="ERROR";
    console.error(e);
  }
}

refresh();
setInterval(refresh,30000);
</script>
</body>
</html>
